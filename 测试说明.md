# Excel检查功能测试说明

## 问题说明

在Windows PowerShell中，`git commit` 时可能不会显示钩子的输出，但钩子实际上是在执行的。如果检查失败，提交会被拦截（返回错误码）。

## 测试方法

### 方法1：手动执行钩子（推荐）

```powershell
# 修改Excel文件后，添加到暂存区
git add excels/*.xlsx

# 手动执行钩子脚本查看输出
python .git/hooks/pre-commit.py
```

如果检查失败，会看到类似这样的输出：

```
============================================================
Excel file checking...
============================================================
Found 1 Excel files to check
开始检查 1 个Excel文件...
使用 10 个线程并行处理
------------------------------------------------------------
[ERROR] excels/数据文件_001.xlsx - 检查失败
  错误: 本地文件未包含远程最新的修订记录: 钱七 - 2025-12-27 23:23:56
------------------------------------------------------------
检查完成: 通过 0 个, 跳过 0 个, 失败 1 个
============================================================
[ERROR] Excel file check failed, commit blocked
Please fix the issues and try again
============================================================
```

### 方法2：使用Git提交（自动触发）

```powershell
# 修改Excel文件后，添加到暂存区
git add excels/*.xlsx

# 尝试提交
git commit -m "test commit"
```

如果检查失败，提交会被拦截（返回错误码1），但可能不会显示钩子的输出。

### 方法3：检查提交是否成功

```powershell
# 尝试提交
git commit -m "test commit"

# 检查返回码
echo $LASTEXITCODE

# 如果返回码是1，说明提交被拦截
# 如果返回码是0，说明提交成功
```

## 测试场景

### 场景1：本地文件未包含远程最新的修订记录

1. 先提交当前版本到远程
   ```powershell
   git add excels/数据文件_001.xlsx
   git commit -m "提交当前版本"
   git push
   ```

2. 模拟远程添加新修订记录
   ```powershell
   # 修改Excel文件，添加新修订记录
   # 然后提交并推送
   git add excels/数据文件_001.xlsx
   git commit -m "远程添加新修订"
   git push
   ```

3. 恢复到旧版本（模拟本地未更新）
   ```powershell
   git reset --hard HEAD~1
   ```

4. 本地修改但不包含远程的新修订记录
   ```powershell
   # 修改Excel文件
   # 添加本地修订记录（但不包含远程的新修订）
   git add excels/数据文件_001.xlsx
   ```

5. 测试提交
   ```powershell
   # 手动执行钩子查看输出
   python .git/hooks/pre-commit.py

   # 或尝试提交
   git commit -m "本地修改"
   ```

**预期结果**：提交被拦截，提示"本地文件未包含远程最新的修订记录"

### 场景2：在最新版本基础上修改

1. 先获取最新版本
   ```powershell
   git pull
   ```

2. 在最新版本基础上修改
   ```powershell
   # 修改Excel文件
   # 添加修订记录（包含远程的新修订）
   git add excels/数据文件_001.xlsx
   ```

3. 测试提交
   ```powershell
   # 手动执行钩子查看输出
   python .git/hooks/pre-commit.py

   # 或尝试提交
   git commit -m "在最新版本基础上修改"
   ```

**预期结果**：检查通过，提交成功

### 场景3：修改修订记录内容

1. 修改最后一条修订记录的内容
   ```powershell
   # 打开Excel文件
   # 修改"修改记录"sheet页最后一条记录的"修订内容"
   ```

2. 测试提交
   ```powershell
   git add excels/数据文件_001.xlsx
   python .git/hooks/pre-commit.py
   ```

**预期结果**：提交被拦截，提示"本地文件未包含远程最新的修订记录"

## 常见问题

### Q1: git commit 时没有显示钩子输出

**原因**：Git在Windows上执行钩子时，输出可能被重定向或缓冲。

**解决**：使用 `python .git/hooks/pre-commit.py` 手动执行钩子查看输出。

### Q2: 如何确认钩子是否被执行

**方法1**：检查返回码
```powershell
git commit -m "test"
echo $LASTEXITCODE
# 如果返回码是1，说明钩子执行失败，提交被拦截
```

**方法2**：检查提交是否成功
```powershell
git commit -m "test"
git log --oneline -1
# 如果没有新的提交，说明提交被拦截
```

### Q3: 如何跳过钩子

```powershell
git commit --no-verify -m "commit message"
```

## 性能测试

测试100个Excel文件的检查速度：

```powershell
# 修改多个Excel文件
# 然后执行
git add excels/*.xlsx
python .git/hooks/pre-commit.py
```

**预期结果**：100个文件在5-10秒内完成检查

## 总结

1. **推荐使用手动执行钩子**：`python .git/hooks/pre-commit.py` 可以看到详细的输出
2. **Git提交时钩子会自动执行**：但可能不会显示输出，只返回错误码
3. **检查失败会拦截提交**：需要先修复问题才能提交
4. **版本一致性检查**：确保本地文件基于远程最新版本
